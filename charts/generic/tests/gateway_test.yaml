suite: test gateway api
templates:
  - networking/gateway/httproute.yaml
  - networking/gateway/tcproute.yaml
  - networking/gateway/referencegrant.yaml
tests:
  # HTTPRoute tests
  - it: should not render HTTPRoute by default
    template: networking/gateway/httproute.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render HTTPRoute when enabled
    template: networking/gateway/httproute.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1/HTTPRoute
    set:
      gateway.httpRoute.enabled: true
      service.ports:
        - name: http
          port: 80
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HTTPRoute
      - equal:
          path: metadata.name
          value: RELEASE-NAME

  - it: should configure parent references
    template: networking/gateway/httproute.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1/HTTPRoute
    set:
      gateway.httpRoute.enabled: true
      gateway.httpRoute.parentRefs:
        - name: custom-gateway
          namespace: gateway-system
          sectionName: https
          port: 443
      service.ports:
        - name: http
          port: 80
    asserts:
      - equal:
          path: spec.parentRefs[0].name
          value: custom-gateway
      - equal:
          path: spec.parentRefs[0].namespace
          value: gateway-system
      - equal:
          path: spec.parentRefs[0].sectionName
          value: https
      - equal:
          path: spec.parentRefs[0].port
          value: 443

  - it: should configure hostnames and rules
    template: networking/gateway/httproute.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1/HTTPRoute
    set:
      gateway.httpRoute.enabled: true
      gateway.httpRoute.hostnames:
        - "example.com"
        - "*.example.com"
      gateway.httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /api
              method: GET
          filters:
            - type: RequestHeaderModifier
              requestHeaderModifier:
                set:
                  - name: x-forwarded-proto
                    value: https
          backendRefs:
            - name: api-service
              port: 8080
              weight: 100
      service.ports:
        - name: http
          port: 80
    asserts:
      - equal:
          path: spec.hostnames
          value: ["example.com", "*.example.com"]
      - equal:
          path: spec.rules[0].matches[0].path.type
          value: PathPrefix
      - equal:
          path: spec.rules[0].matches[0].path.value
          value: /api
      - equal:
          path: spec.rules[0].matches[0].method
          value: GET
      - equal:
          path: spec.rules[0].filters[0].type
          value: RequestHeaderModifier
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: api-service
      - equal:
          path: spec.rules[0].backendRefs[0].weight
          value: 100

  - it: should create extra HTTPRoutes
    template: networking/gateway/httproute.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1/HTTPRoute
    set:
      gateway.httpRoute.enabled: true
      gateway.httpRoute.extraRoutes:
        api:
          enabled: true
          hostnames:
            - api.example.com
          rules:
            - matches:
                - path:
                    type: PathPrefix
                    value: /v1
              backendRefs:
                - name: api-v1-service
                  port: 8080
      service.ports:
        - name: http
          port: 80
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.name
          value: RELEASE-NAME-api
        documentIndex: 1
      - equal:
          path: spec.hostnames[0]
          value: api.example.com
        documentIndex: 1

  # TCPRoute tests
  - it: should not render TCPRoute by default
    template: networking/gateway/tcproute.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render TCPRoute when enabled
    template: networking/gateway/tcproute.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1alpha2/TCPRoute
    set:
      gateway.tcpRoute.enabled: true
      service.ports:
        - name: tcp
          port: 9000
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: TCPRoute
      - equal:
          path: metadata.name
          value: RELEASE-NAME-tcp

  - it: should configure default TCP backend
    template: networking/gateway/tcproute.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1alpha2/TCPRoute
    set:
      gateway.tcpRoute.enabled: true
      service.ports:
        - name: tcp
          port: 9000
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: RELEASE-NAME
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 9000

  - it: should configure custom TCP rules
    template: networking/gateway/tcproute.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1alpha2/TCPRoute
    set:
      gateway.tcpRoute.enabled: true
      gateway.tcpRoute.rules:
        - backendRefs:
            - name: tcp-service
              port: 9000
              weight: 90
            - name: tcp-backup
              port: 9000
              weight: 10
      service.ports:
        - name: tcp
          port: 9000
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: tcp-service
      - equal:
          path: spec.rules[0].backendRefs[0].weight
          value: 90
      - equal:
          path: spec.rules[0].backendRefs[1].name
          value: tcp-backup

  - it: should create extra TCPRoutes
    template: networking/gateway/tcproute.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1alpha2/TCPRoute
    set:
      gateway.tcpRoute.enabled: true
      gateway.tcpRoute.extraRoutes:
        database:
          enabled: true
          rules:
            - backendRefs:
                - name: postgres-primary
                  port: 5432
                  weight: 70
      service.ports:
        - name: tcp
          port: 9000
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.name
          value: RELEASE-NAME-database-tcp
        documentIndex: 1
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: postgres-primary
        documentIndex: 1

  # ReferenceGrant tests
  - it: should not render ReferenceGrant by default
    template: networking/gateway/referencegrant.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render ReferenceGrant when enabled
    template: networking/gateway/referencegrant.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1beta1/ReferenceGrant
    set:
      gateway.referenceGrant.enabled: true
      gateway.referenceGrant.from:
        - group: gateway.networking.k8s.io
          kind: Gateway
          namespace: gateway-system
      gateway.referenceGrant.to:
        - group: ""
          kind: Service
          name: backend-service
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ReferenceGrant
      - equal:
          path: spec.from[0].group
          value: gateway.networking.k8s.io
      - equal:
          path: spec.from[0].kind
          value: Gateway
      - equal:
          path: spec.from[0].namespace
          value: gateway-system
      - equal:
          path: spec.to[0].group
          value: ""
      - equal:
          path: spec.to[0].kind
          value: Service

  - it: should create extra ReferenceGrants
    template: networking/gateway/referencegrant.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1beta1/ReferenceGrant
    set:
      gateway.referenceGrant.enabled: true
      gateway.referenceGrant.from:
        - group: gateway.networking.k8s.io
          kind: HTTPRoute
      gateway.referenceGrant.to:
        - group: ""
          kind: Service
      gateway.referenceGrant.extraGrants:
        secrets:
          enabled: true
          from:
            - group: gateway.networking.k8s.io
              kind: Gateway
              namespace: gateway-system
          to:
            - group: ""
              kind: Secret
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.name
          value: RELEASE-NAME-secrets
        documentIndex: 1
