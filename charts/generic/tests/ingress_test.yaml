suite: test ingress
templates:
  - networking/ingress.yaml
tests:
  - it: should not create ingress by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create ingress when enabled
    set:
      ingress.enabled: true
    asserts:
      - isKind:
          of: Ingress
      - equal:
          path: metadata.name
          value: RELEASE-NAME

  - it: should set ingress class name
    set:
      ingress.enabled: true
      ingress.className: nginx
    capabilities:
      apiVersions:
        - networking.k8s.io/v1
    asserts:
      - equal:
          path: spec.ingressClassName
          value: nginx

  - it: should create rules with default host
    set:
      ingress.enabled: true
      ingress.hosts:
        - host: chart-example.local
          paths:
            - path: /
              pathType: ImplementationSpecific
    asserts:
      - equal:
          path: spec.rules[0].host
          value: chart-example.local
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: ImplementationSpecific

  - it: should create multiple hosts
    set:
      ingress.enabled: true
      ingress.hosts:
        - host: app1.example.com
          paths:
            - path: /
              pathType: Prefix
        - host: app2.example.com
          paths:
            - path: /api
              pathType: Exact
    asserts:
      - equal:
          path: spec.rules[0].host
          value: app1.example.com
      - equal:
          path: spec.rules[1].host
          value: app2.example.com
      - equal:
          path: spec.rules[1].http.paths[0].path
          value: /api


  - it: should add annotations
    set:
      ingress.enabled: true
      ingress.annotations:
        alb.ingress.kubernetes.io/scheme: internet-facing
        alb.ingress.kubernetes.io/target-type: ip
    asserts:
      - equal:
          path: metadata.annotations
          value:
            alb.ingress.kubernetes.io/scheme: internet-facing
            alb.ingress.kubernetes.io/target-type: ip

  - it: should use v1 API version for Kubernetes 1.29+
    set:
      ingress.enabled: true
    asserts:
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1
