{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "nameOverride": {
      "type": "string",
      "description": "Override the chart name"
    },
    "fullnameOverride": {
      "type": "string",
      "description": "Override the full chart name"
    },
    "global": {
      "type": "object",
      "properties": {
        "eksDiscovery": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable EKS discovery"
            },
            "clusterName": {
              "type": "string",
              "description": "Cluster name for tagging and discovery"
            },
            "tags": {
              "type": "object",
              "description": "Custom discovery tags for subnets and security groups",
              "properties": {
                "subnets": {
                  "type": "object",
                  "description": "Tags for subnet discovery",
                  "additionalProperties": {
                    "type": "string"
                  }
                },
                "securityGroups": {
                  "type": "object",
                  "description": "Tags for security group discovery",
                  "additionalProperties": {
                    "type": "string"
                  }
                }
              }
            }
          },
          "required": ["enabled"]
        },
        "role": {
          "type": "string",
          "description": "Karpenter Role Name for node IAM permissions"
        }
      },
      "required": ["role"]
    },
    "nodePools": {
      "type": "object",
      "patternProperties": {
        "^[a-zA-Z0-9-_]+$": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable this NodePool"
            },
            "labels": {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              }
            },
            "annotations": {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              }
            },
            "nodeClassRef": {
              "type": "object",
              "properties": {
                "group": {
                  "type": "string"
                },
                "kind": {
                  "type": "string"
                },
                "name": {
                  "type": "string"
                }
              },
              "required": ["group", "kind", "name"]
            },
            "taints": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "key": {
                    "type": "string"
                  },
                  "value": {
                    "type": "string"
                  },
                  "effect": {
                    "type": "string",
                    "enum": ["NoSchedule", "PreferNoSchedule", "NoExecute"]
                  }
                },
                "required": ["key", "effect"]
              }
            },
            "startupTaints": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "key": {
                    "type": "string"
                  },
                  "value": {
                    "type": "string"
                  },
                  "effect": {
                    "type": "string",
                    "enum": ["NoSchedule", "PreferNoSchedule", "NoExecute"]
                  }
                },
                "required": ["key", "effect"]
              }
            },
            "expireAfter": {
              "type": "string",
              "pattern": "^([0-9]+[hms])|Never$",
              "description": "Node expiry duration or 'Never'"
            },
            "requirements": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "key": {
                    "type": "string"
                  },
                  "operator": {
                    "type": "string",
                    "enum": ["In", "NotIn", "Exists", "DoesNotExist", "Gt", "Lt", "Gte", "Lte"]
                  },
                  "values": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": ["key", "operator"]
              }
            },
            "disruption": {
              "type": "object",
              "properties": {
                "consolidationPolicy": {
                  "type": "string",
                  "enum": ["WhenEmptyOrUnderutilized", "WhenUnderutilized", "Never"]
                },
                "consolidateAfter": {
                  "type": "string",
                  "pattern": "^[0-9]+[hms]$"
                }
              }
            },
            "limits": {
              "type": "object",
              "properties": {
                "cpu": {
                  "type": "integer"
                },
                "memory": {
                  "type": "string",
                  "pattern": "^[0-9]+[KMGTPe]i$"
                }
              },
              "required": ["cpu", "memory"]
            }
          },
          "required": ["enabled", "nodeClassRef", "requirements"]
        }
      }
    },
    "ec2NodeClasses": {
      "type": "object",
      "patternProperties": {
        "^[a-zA-Z0-9-_]+$": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable this EC2NodeClass"
            },
            "kubelet": {
              "type": "object",
              "additionalProperties": true
            },
            "amiFamily": {
              "type": "string",
              "description": "AMI family that defines UserData format and block device mappings",
              "enum": ["AL2", "AL2023", "Bottlerocket", "Custom", "Windows2019", "Windows2022"]
            },
            "amiSelectorTerms": {
              "type": "array",
              "description": "REQUIRED: AMI selection criteria for Karpenter v1+",
              "minItems": 1,
              "items": {
                "type": "object",
                "properties": {
                  "alias": {
                    "type": "string",
                    "description": "EKS optimized AMI selection (e.g., al2@latest, bottlerocket@latest)"
                  },
                  "id": {
                    "type": "string",
                    "description": "Specific AMI ID"
                  },
                  "name": {
                    "type": "string",
                    "description": "AMI name pattern"
                  },
                  "owner": {
                    "type": "string",
                    "description": "AWS account ID or alias",
                    "enum": ["self", "amazon", "aws-marketplace"]
                  },
                  "tags": {
                    "type": "object",
                    "description": "Tags for AMI selection",
                    "additionalProperties": {
                      "type": "string"
                    }
                  }
                }
              }
            },
            "capacityReservationSelectorTerms": {
              "type": "array",
              "description": "On-Demand Capacity Reservation selection criteria",
              "items": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "string",
                    "description": "Specific Capacity Reservation ID"
                  },
                  "tags": {
                    "type": "object",
                    "description": "Tags for Capacity Reservation selection",
                    "additionalProperties": {
                      "type": "string"
                    }
                  }
                }
              }
            },
            "subnetSelectorTerms": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "string"
                  },
                  "tags": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "string"
                    }
                  }
                }
              }
            },
            "securityGroupSelectorTerms": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "string"
                  },
                  "name": {
                    "type": "string"
                  },
                  "tags": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "string"
                    }
                  }
                }
              }
            },
            "role": {
              "type": "string",
              "description": "REQUIRED: AWS IAM role for EC2 instances (replaces instanceProfile in v1+)"
            },
            "tags": {
              "type": "object",
              "description": "Tags to apply to EC2 instances",
              "additionalProperties": {
                "type": "string"
              }
            },
            "associatePublicIPAddress": {
              "type": "boolean",
              "description": "Whether to associate public IP addresses with instances"
            },
            "instanceStorePolicy": {
              "type": "string",
              "description": "Policy for handling instance store disks",
              "enum": ["RAID0", "NVME"]
            },
            "metadataOptions": {
              "type": "object",
              "description": "EC2 instance metadata service configuration",
              "properties": {
                "httpEndpoint": {
                  "type": "string",
                  "description": "Enable or disable the HTTP metadata endpoint",
                  "enum": ["enabled", "disabled"]
                },
                "httpProtocolIPv6": {
                  "type": "string",
                  "description": "Enable or disable the IPv6 endpoint for IMDS",
                  "enum": ["enabled", "disabled"]
                },
                "httpPutResponseHopLimit": {
                  "type": "integer",
                  "description": "Hop limit for metadata token (1 = host only, 2+ = containers)",
                  "minimum": 1,
                  "maximum": 64
                },
                "httpTokens": {
                  "type": "string",
                  "description": "Whether IMDSv2 tokens are required",
                  "enum": ["optional", "required"]
                }
              }
            },
            "blockDeviceMappings": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "deviceName": {
                    "type": "string"
                  },
                  "ebs": {
                    "type": "object",
                    "properties": {
                      "volumeSize": {
                        "type": "string",
                        "pattern": "^[0-9]+[KMGTPe]i$"
                      },
                      "volumeType": {
                        "type": "string",
                        "enum": ["gp2", "gp3", "io1", "io2", "sc1", "st1"]
                      },
                      "encrypted": {
                        "type": "boolean"
                      },
                      "deleteOnTermination": {
                        "type": "boolean"
                      },
                      "iops": {
                        "type": "integer",
                        "minimum": 100
                      },
                      "throughput": {
                        "type": "integer",
                        "minimum": 125
                      }
                    },
                    "required": ["volumeSize", "volumeType"]
                  }
                },
                "required": ["deviceName", "ebs"]
              }
            }
          },
          "required": ["enabled"],
          "if": {
            "properties": {
              "enabled": {
                "const": true
              }
            }
          },
          "then": {
            "required": ["amiSelectorTerms", "amiFamily"]
          }
        }
      }
    }
  }
}
